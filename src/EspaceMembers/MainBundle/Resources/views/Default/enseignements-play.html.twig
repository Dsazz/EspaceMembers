{% extends 'EspaceMembersMainBundle::layout.html.twig' %}

{% block enseignement_active %}
    <li class="current">
        <a class="active enseignements" href="{{ path ('espace_members_teaching') }}">Enseignements</a>
    </li>
{% endblock enseignement_active %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" type="text/css" href="{{ asset('bundles/espacemembersmain/css/msdropdown/dd.css') }}" />
{% endblock %}
{% block javascript %}
    {{ parent() }}
    {#<script src="{{ asset('bundles/espacemembersmain/js/msdropdown/jquery-1.3.2.min.js') }}" type="text/javascript"></script>#}
    <script src="{{ asset('bundles/espacemembersmain/js/msdropdown/jquery.dd.min.js') }}" type="text/javascript"></script>
    <script language="javascript">
        $(document).ready(function(e) {
            try {
                $("body select").msDropDown();
                } catch(e) {
                    alert(e.message);
            }
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function(){
            $("ul.menu li a").click(function(){
                $(this).parent().find("ul.sub-menu").slideToggle() ; 
                $(this).toggleClass("actived"); });

            $('#webmenu').on('change', function() {
            	var link = $(this).val();
            	location.href = link;
            });
        });

        function triggerBookmark(teaching_id){
            var self = this;
            var addBookmark = ($(this).hasClass('fav') == false) ?
                this : $('div.favbox a[data-id='+teaching_id+']');
            var pathBookmarkAction;
            if ($(self).hasClass('active')) {
                pathBookmarkAction = '{{path('espace_members_bookmark_remove')}}';

                $(self).removeClass('active');
                $(addBookmark).addClass('unactive');
                $(addBookmark).text('AJOUTER A MES FAVORIS');
                $.post(pathBookmarkAction, {teaching_id: teaching_id},
                    function(response){
                        if(response.code == 100 && response.success == false){
                            $(self).addClass('active');
                            if ( addBookmark ) {
                                $(addBookmark).removeClass('unactive');
                                $(addBookmark).text('ENLEVER DE MES FAVORIS');
                            }
                        }

                    }, "json");
            } else {
                pathBookmarkAction = '{{path('espace_members_bookmark_add')}}';

                $(self).addClass('active');
                $(addBookmark).removeClass('unactive');
                $(addBookmark).text('ENLEVER DE MES FAVORIS');
                $.post(pathBookmarkAction, {teaching_id: teaching_id},
                    function(response){
                        if(response.code == 100 && response.success == false){
                            $(self).removeClass('active');
                            if ( addBookmark ) {
                                $(addBookmark).addClass('unactive');
                                $(addBookmark).text('AJOUTER A MES FAVORIS');
                            }
                        }

                    }, "json");
            }
        }

		function arrowAction(teachings, teachingCurr) {
			var leftArrow  = $('div.num-list a.left-arrow');
			var rightArrow = $('div.num-list a.right-arrow');
			if($(teachings).find('li').first().attr('data-serial') == $(teachingCurr).attr('data-serial') &&
				$(teachings).find('li').last().attr('data-serial') == $(teachingCurr).attr('data-serial')) {
					$(rightArrow).attr('href', '#');
					$(rightArrow).removeClass('right-arrow-actived');
					$(leftArrow).attr('href', '#');
					$(leftArrow).removeClass('left-arrow-actived');
			} else if($(teachings).find('li').first().attr('data-serial') == $(teachingCurr).attr('data-serial')) {
				$(leftArrow).attr('href', '#');
				$(leftArrow).removeClass('left-arrow-actived');
				if($(teachings).find('li').last().attr('data-serial') == $(teachingCurr).attr('data-serial')) {
					$(rightArrow).attr('href', '#')
					$(rightArrow).removeClass('right-arrow-actived');
				} else {
					$(rightArrow).attr('href', $(teachingCurr).next().find('a.play').attr('href'));
					$(rightArrow).addClass('right-arrow-actived');
				}
			} else if($(teachings).find('li').last().attr('data-serial') == $(teachingCurr).attr('data-serial')) {
				$(rightArrow).attr('href', '#');
				$(rightArrow).removeClass('right-arrow-actived');
				$(leftArrow).attr('href', $(teachingCurr).prev().find('a.play').attr('href'));
				$(leftArrow).addClass('left-arrow-actived');
			} else {
				$(rightArrow).attr('href', $(teachingCurr).next().find('a.play').attr('href'));
				$(rightArrow).addClass('right-arrow-actived');
				$(leftArrow).attr('href', $(teachingCurr).prev().find('a.play').attr('href'));
				$(leftArrow).addClass('left-arrow-actived');
			}
		}

        $(document).ready(function() {
            $('.favbox a').on('click', function(){
                var teaching_id = $(this).attr('data-id');
                triggerBookmark.call(this, teaching_id);
                return false;
            });
            $('.sub-menu li a.fav').on('click', function(){
                var teaching_id = $(this).attr('data-id');
                triggerBookmark.call(this, teaching_id);
                return false;
            });


			var teachings = $('ul.sub-menu');
			var teachingCurrId = $('ul.menu a[data-curr-serial]').attr('data-curr-serial');
			var teachingCurr = $(teachings).find('[data-serial='+teachingCurrId+']');
			arrowAction.call(this, teachings, teachingCurr);

            $('div.num-list a.left-arrow').on('click', function(){
                var teachings = $('ul.sub-menu');
                var teachingCurrId = $('ul.menu a[data-curr-serial]').attr('data-curr-serial');
				var teachingCurr = $(teachings).find('[data-serial='+teachingCurrId+']');
				if($(teachings).find('li').first().attr('[data-serial]') !== $(teachingsCurr).attr('[data-serial]')) {
					teachingsCurr = $(teachingsCurr).prev();
				}

                arrowAction.call(this, teachings, teachingCurr);
                return false;
            });
        });
    </script>
{% endblock %}

{% block body %}
<div class="content">
    {% if app.user %}
        {% set bookmarks = app.security.getToken().getUser().getBookmarks() %}
    {% endif %}
    <div class="topbar">
        {% media event.frontImage, 'small' with { 
            'width': '50px', 'height': '50px', 'class': 'leftimg', 'alt': 'image', 'title': '' 
        } %}

        <h2>{{ event.title|capitalize }}</h2>

        <div class="rightside">
            <div class="profile-name">
                <select name="webmenu" id="webmenu">
                    {% for teacher in event.users %}
                        {% if teacher.id == teacherCurr.id %}
						<option value="{{ path('espace_members_playing_teaching', {
									'event_id' : event.id,
									'teacher_id' : teacher.id,
									'teaching_id' : teacher.teachings.first().id
								} ) }}" selected="selected" title="{% path teacher.avatar, 'very_small' %}">
                        {% else %}
						<option value="{{ path('espace_members_playing_teaching', {
								'event_id' : event.id,
								'teacher_id' : teacher.id,
								'teaching_id' : teacher.teachings.first().id
							} ) }}" data-image="{% path teacher.avatar, 'very_small' %}">
                        {% endif %}
							{{ teacher.lastName }} {{ teacher.firstName }}
						</option>
                    {% endfor %}
                </select>
            </div>
            <div class="num-list">
                <a class="left-arrow" href="#"></a>
                <a class="right-arrow" href="#"></a>
                <ul class="menu" data-max="{{ teacherCurr.teachings|filterLesson( event.title )|length }}">
                    <li>
						<a style="cursor:pointer;" data-curr-serial="{{ teachingCurr.serial }}">
							Causerie {{ teachingCurr.serial }} / {{ teacherCurr.teachings|filterLesson( event.title )|length }}
						</a>
                        <ul class="sub-menu" style="display: none;">
                        {% for teaching in teacherCurr.teachings|filterLesson( event.title ) %}
							<li data-serial="{{ teaching.serial }}">
								<span class="categorie">Causerie {{ teaching.serial }}</span>
								<a href="{{ path('espace_members_playing_teaching', {
									'event_id' : event.id,
									'teacher_id' : teacherCurr.id,
									'teaching_id' : teaching.id
								} ) }}" class="tittle">
									{{ teaching.title|length > 20 ?  teaching.title|slice(0, 20) ~ '...' : teaching.title }}
									<span class="uploaded-time">Jour {{ teaching.dayNumber }},
										{{ teaching.date|localizeddate('none', 'none', 'fr_FR' , null, 'd
										LLLL Y') }} (env. {{teaching.dayTime}} )
									</span>
								</a>
								{#<a href="#" class="play">#}
								<a href="{{ path('espace_members_playing_teaching', {
									'event_id' : event.id,
									'teacher_id' : teacherCurr.id,
									'teaching_id' : teaching.id
								} ) }}" class="play">
									{% if teaching.lesson.contentType == 'audio/mpeg' %}
									<img src="{{ asset('bundles/espacemembersmain/images/audio.png') }}" alt="icon" />
									{% else %}
									<img src="{{ asset('bundles/espacemembersmain/images/video.png') }}" alt="icon" />
									{% endif %}
								</a>
								{% set pathToMedia  %} {% path teaching.lesson, "reference" %} {% endset %}
								<span class="time">{{ teaching.lesson.getPlayingTime(pathToMedia) }}</span>

								<a href="#" class="follow fav {% if bookmarks is defined and
									bookmarks|filterIsBookmark(teaching.id) %} active {% endif %}" 
									data-id='{{ teaching.id }}' >
								</a>
							</li>
                        {% endfor %}

                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
      
    <video controls>
        <source src="{% path teachingCurr.lesson, 'reference' %}" type="{{ teachingCurr.lesson.contentType }}">
        Your browser does not support the video tag.
    </video> 

    <div class="full-width2">

        <div class="favbox">
            <h2>{{ teachingCurr.title|capitalize }}</h2>

            {% if bookmarks is defined and bookmarks|filterIsBookmark(teachingCurr.id) %}
                <a href="#" class="active" data-id="{{ teachingCurr.id }}">ENLEVER DE MES FAVORIS</a>
            {% else %}
                <a href="#" class="unactive" data-id="{{ teachingCurr.id }}">AJOUTER A MES FAVORIS</a>
            {% endif %}
        </div>

        <div class="left-bar2">

            <p class="heading">{{ event.title|capitalize }}</p>
            <p>Causerie {{ teachingCurr.serial }}<br />
            <span style="color:#282629;">{{ teachingCurr.date|localizeddate('none', 'none', 'fr_FR' , null, 'd LLLL Y') }}</span><br />
            Jour {{ teachingCurr.dayNumber }}, {{teachingCurr.dayTime}}
            </p>

            <p>Enseignant(s):<br />
            {% for teacher in teachingCurr.users %}
                <a href="{{ path('espace_members_filter_teaching_teacher', {
                        'teacher_id': teacher.id}) }}" class="link">
                    {{ teacher.lastName }} {{ teacher.firstName }}
                </a>
            {% endfor %}
            </p>

            <p>Catégorie:<br />
                {{ event.category.title|capitalize }}
            </p>

            <p>Voie(s):<br />
                {% set voiesTitles %}
                    {% for voie in teachingCurr.voies %}
                        {%if voie == teachingCurr.voies|last%} 
                            {{ voie.title }}
                        {% else %}
                            {{ voie.title }},
                        {% endif %}
                    {% endfor %}
                {% endset %}
                {{ voiesTitles[0:voiesTitles|length]|title }}
            </p>

            <p>Thèmes:<br />
            {% for tag in teachingCurr.tags %}
                <a href="{{ path('espace_members_filter_teaching_tag', {
                        'tag_id': tag.id}) }}" class="theme-button">{{ tag.title }}</a>
            {% else %}
                <a href="#" class="theme-button">Not found tag</a>
            {% endfor %}
            </p>

        </div>

        <div class="right-bar2">

            <div class="box">
                <p>{{ teachingCurr.resume }}</p>
            </div>
        </div>
    </div>
</div>

<div class="clear"><!-- --></div>
{% endblock %}
